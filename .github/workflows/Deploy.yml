name: Deploy to Hostinger (Clean & Silent)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1
        with:
          host: 72.61.237.199
          username: sarthakedge1
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e

            BASE_DIR=/home/sarthakedge1/htdocs
            TARGET_DIR=$BASE_DIR/beta.sarthakedge.com/php_code
            TIMESTAMP=$(date +"%Y%m%d%H%M%S")
            BACKUP_DIR=$BASE_DIR/beta.sarthakedge.com_backup_$TIMESTAMP

            echo " Backup current release"
            if [ -d "$TARGET_DIR" ]; then
              rsync -a \
                --exclude="logs" \
                --exclude="storage/logs" \
                --exclude="tmp" \
                --exclude=".cache" \
                $TARGET_DIR/ $BACKUP_DIR/
            fi

            echo " Keep only last 3 backups"
            ls -dt $BASE_DIR/beta.sarthakedge.com_backup_* | tail -n +4 | xargs -r rm -rf

            echo " Deploy new release"
            rsync -az --delete \
              --exclude=".git" \
              --exclude="node_modules" \
              --exclude="logs" \
              --exclude="storage/logs" \
              --exclude="tmp" \
              --exclude=".cache" \
              ./ $TARGET_DIR/ || true

            echo " Ensure Laravel directories"
            mkdir -p \
              $TARGET_DIR/storage/framework/cache \
              $TARGET_DIR/storage/framework/views \
              $TARGET_DIR/storage/logs \
              $TARGET_DIR/bootstrap/cache \
              $TARGET_DIR/tmp \
              $TARGET_DIR/.cache

            chown -R sarthakedge1:sarthakedge1 $TARGET_DIR
            chmod -R 775 \
              $TARGET_DIR/storage \
              $TARGET_DIR/bootstrap/cache \
              $TARGET_DIR/tmp \
              $TARGET_DIR/.cache

            echo "Deployment OK - $(TZ=Asia/Kolkata date)" > $TARGET_DIR/deploy_log.txt

            echo " DEPLOY SUCCESS"
